<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyChicken - Kasir Ayam</title>
    <link rel="icon" href="AztaoTech.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .bg-custom-orange { background-color: #F97316; }
        .text-custom-orange { color: #F97316; }
        .shadow-custom-orange { box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.1), 0 4px 6px -2px rgba(249, 115, 22, 0.05); }
        .off-screen-struk {
            position: absolute;
            left: -9999px;
            top: -9999px;
            z-index: -10;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-amber-100 min-h-screen">

    <div class="container mx-auto px-4 py-8 max-w-lg">
        <div id="page1" class="page-content">
            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6 border-b-4 border-custom-orange">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2 animate-bounce">üêî</div>
                    <h1 class="text-3xl font-bold text-gray-800">My Chicken</h1>
                    <p class="text-gray-600 text-sm">Hitung harga ayam berdasarkan berat</p>
                </div>

                <div class="bg-orange-50 rounded-xl p-4 mb-6">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        ‚öôÔ∏è Pengaturan Harga
                    </h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Harga per Kg</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                            <input type="number" id="hargaPerKg" value="35000" 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent">
                        </div>
                    </div>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Berat Total (Kg)</label>
                        <input type="number" id="beratTotal" step="0.1" placeholder="0.0"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent text-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Ekor</label>
                        <input type="number" id="jumlahEkor" placeholder="0"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent text-lg">
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 mb-6">
                    <h3 class="font-semibold text-gray-700 mb-3">üí∞ Total Harga</h3>
                    <div class="text-3xl font-bold text-custom-orange" id="totalHarga">Rp 0</div>
                    <div class="text-sm text-gray-600 mt-1" id="detailHarga">0 kg √ó Rp 0 = Rp 0</div>
                </div>

                <button onclick="lanjutKeHalaman2()" id="btnLanjut" disabled
                        class="w-full bg-custom-orange hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                    Lanjut ke Pembayaran ‚Üí
                </button>
            </div>
            <div class="flex justify-center mt-4 space-x-4">
                <button onclick="lanjutKeHutang()" class="text-sm text-custom-orange hover:underline">
                    Lihat Daftar Hutang ‚Üí
                </button>
                <button onclick="lanjutKeRiwayat()" class="text-sm text-custom-orange hover:underline">
                    Lihat Riwayat Transaksi ‚Üí
                </button>
                <button onclick="lanjutKeLaporan()" class="text-sm text-custom-orange hover:underline">
                    Lihat Laporan Penjualan ‚Üí
                </button>
            </div>
        </div>

        <div id="page2" class="page-content hidden">
            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6 border-b-4 border-custom-orange">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üìù</div>
                    <h1 class="text-3xl font-bold text-gray-800">Detail Pembeli</h1>
                    <p class="text-gray-600 text-sm">Lengkapi informasi pembayaran</p>
                </div>

                <div class="bg-orange-50 rounded-xl p-4 mb-6">
                    <h3 class="font-semibold text-gray-700 mb-2">üìã Ringkasan Pesanan</h3>
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between">
                            <span>Berat:</span>
                            <span id="ringkasanBerat">0 kg</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Jumlah Ekor:</span>
                            <span id="ringkasanEkor">0 ekor</span>
                        </div>
                        <div class="flex justify-between font-semibold text-custom-orange">
                            <span>Total:</span>
                            <span id="ringkasanTotal">Rp 0</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pembeli</label>
                        <input type="text" id="namaPembeli" placeholder="Masukkan nama pembeli"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent text-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Uang Dibayarkan</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                            <input type="number" id="uangDibayar" placeholder="0"
                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent text-lg">
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 rounded-xl p-4">
                        <h3 class="font-semibold text-gray-700 mb-3">üî™ Layanan Bubut</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="radio" name="bubut" value="tidak" checked
                                       class="w-4 h-4 text-custom-orange focus:ring-custom-orange">
                                <span class="ml-2 text-sm">Tidak perlu dibubut</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="bubut" value="ya"
                                       class="w-4 h-4 text-custom-orange focus:ring-custom-orange">
                                <span class="ml-2 text-sm">Ya, bubut ayam</span>
                            </label>
                        </div>
                        
                        <div id="hargaBubutContainer" class="mt-3 hidden">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Harga Bubut per Ekor</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                                <input type="number" id="hargaBubut" value="5000"
                                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>Harga Ayam:</span>
                                <span id="hargaAyamFinal">Rp 0</span>
                            </div>
                            <div class="flex justify-between text-sm" id="hargaBubutRow" style="display: none;">
                                <span>Biaya Bubut:</span>
                                <span id="biayaBubut">Rp 0</span>
                            </div>
                            <hr class="my-2">
                            <div class="flex justify-between font-bold text-lg text-custom-orange">
                                <span>Total Bayar:</span>
                                <span id="totalBayar">Rp 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-green-50 rounded-xl p-4" id="kembalianContainer" style="display: none;">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-700">üíµ Kembalian:</span>
                            <span class="text-xl font-bold text-green-600" id="kembalian">Rp 0</span>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col space-y-3 mt-4">
                    <button onclick="selesaikanTransaksi()" id="btnSelesai"
                            class="w-full bg-custom-orange hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                        Selesaikan Transaksi
                    </button>
                    <button onclick="simpanHutang()" id="btnHutang"
                            class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                        Simpan sebagai Hutang
                    </button>
                    <button onclick="kembaliKeHalaman1()"
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                        ‚Üê Kembali
                    </button>
                </div>
            </div>
        </div>

        <div id="page3" class="page-content hidden">
            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6 border-b-4 border-custom-orange">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">‚úÖ</div>
                    <h1 class="text-3xl font-bold text-gray-800">Transaksi Selesai</h1>
                    <p class="text-gray-600 text-sm">Terima kasih atas pembeliannya!</p>
                </div>

                <div id="struk" class="bg-gray-50 rounded-xl p-6 mb-6 font-mono border-l-4 border-green-400">
                    <div class="text-center">
                        <h2 class="text-lg font-bold">üêî MyChicken</h2>
                        <p class="text-xs text-gray-600">Jl. Anjah Anjah, Desa Rempek Darussalam</p>
                        <hr class="my-4 border-dashed border-gray-400">
                    </div>
                    
                    <div class="text-sm space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Nama Pembeli:</span>
                            <span id="strukNama" class="font-bold">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Tanggal:</span>
                            <span id="tanggalTransaksi" class="font-semibold text-gray-800"></span>
                        </div>
                        <hr class="my-4 border-dashed border-gray-400">
                        <div class="flex justify-between">
                            <span>Berat Ayam:</span>
                            <span id="strukBerat">0 kg</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Jumlah Ekor:</span>
                            <span><span id="strukEkor">0</span> ekor</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Harga/Kg:</span>
                            <span id="strukHargaKg">Rp 0</span>
                        </div>
                        <div class="flex justify-between font-semibold">
                            <span>Subtotal Ayam:</span>
                            <span id="strukSubtotal">Rp 0</span>
                        </div>
                        <div class="flex justify-between" id="strukBubutRow" style="display: none;">
                            <span>Biaya Bubut:</span>
                            <span id="strukBiayaBubut">Rp 0</span>
                        </div>
                    </div>
                    
                    <hr class="my-4 border-dashed border-gray-400">
                    
                    <div class="space-y-2">
                        <div class="flex justify-between items-center font-bold text-lg text-custom-orange">
                            <span>Total:</span>
                            <span id="strukTotal">Rp 0</span>
                        </div>
                        
                        <div class="flex justify-between items-center text-sm" id="strukDibayarRow">
                            <span class="text-gray-600">Uang Dibayar:</span>
                            <span id="strukDibayar">Rp 0</span>
                        </div>
                        
                        <div class="flex justify-between items-center font-semibold text-red-600" id="strukSisaHutangRow" style="display: none;">
                            <span>Sisa Hutang:</span>
                            <span id="strukSisaHutang">Rp 0</span>
                        </div>
                        
                        <div class="flex justify-between items-center font-semibold text-green-600" id="strukKembalianRow" style="display: none;">
                            <span>Kembalian:</span>
                            <span id="strukKembalian">Rp 0</span>
                        </div>
                    </div>
                    
                    <div class="text-center text-sm text-gray-500 mt-6">
                        <p>Terima kasih telah berbelanja!</p>
                    </div>
                </div>

                <div class="flex flex-col space-y-3 mt-4">
                    <button onclick="transaksiBaru()"
                            class="w-full bg-custom-orange hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                        üîÑ Transaksi Baru
                    </button>
                    <button onclick="downloadStruk()"
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                        ‚¨áÔ∏è Download Struk
                    </button>
                </div>
            </div>
        </div>

        <div id="page4" class="page-content hidden">
            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6 border-b-4 border-custom-orange">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üí∏</div>
                    <h1 class="text-3xl font-bold text-gray-800">Daftar Hutang</h1>
                    <p class="text-gray-600 text-sm" id="infoHutang"></p>
                </div>
                
                <div id="daftarHutang" class="space-y-4">
                </div>
                
                <button onclick="kembaliKeHalaman1()"
                        class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                    ‚Üê Kembali ke Beranda
                </button>
            </div>
        </div>

        <div id="page5" class="page-content hidden">
            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6 border-b-4 border-custom-orange">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üìú</div>
                    <h1 class="text-3xl font-bold text-gray-800">Riwayat Transaksi</h1>
                    <p class="text-gray-600 text-sm" id="infoRiwayat"></p>
                </div>
                
                <div id="daftarRiwayat" class="space-y-4">
                </div>
                
                <button onclick="kembaliKeHalaman1()"
                        class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                    ‚Üê Kembali ke Beranda
                </button>
            </div>
        </div>

        <div id="page6" class="page-content hidden">
            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6 border-b-4 border-custom-orange">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üìä</div>
                    <h1 class="text-3xl font-bold text-gray-800">Laporan Penjualan</h1>
                    <p class="text-gray-600 text-sm">Analisis penjualan Anda</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                    <div class="bg-blue-100 p-4 rounded-xl">
                        <p class="text-sm text-blue-600">Penjualan Hari Ini</p>
                        <p id="totalHarian" class="text-xl font-bold text-blue-800">Rp 0</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-xl">
                        <p class="text-sm text-purple-600">Penjualan Bulan Ini</p>
                        <p id="totalBulanan" class="text-xl font-bold text-purple-800">Rp 0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-xl">
                        <p class="text-sm text-green-600">Total Keseluruhan</p>
                        <p id="totalKeseluruhan" class="text-xl font-bold text-green-800">Rp 0</p>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Tren Penjualan Bulanan</h3>
                    <canvas id="grafikPenjualan"></canvas>
                </div>
                
                <button onclick="kembaliKeHalaman1()"
                        class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                    ‚Üê Kembali ke Beranda
                </button>
            </div>
        </div>
    </div>

    <div id="modalBayarHutang" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Pembayaran Hutang</h2>
            <div class="mb-4">
                <p class="text-sm text-gray-600">Nama: <span id="modalNamaHutang" class="font-semibold"></span></p>
                <p class="text-sm text-gray-600">Total Hutang: <span id="modalTotalHutang" class="font-semibold text-red-600"></span></p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Pembayaran</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                    <input type="number" id="inputBayarHutang" placeholder="0"
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="tutupModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                <button onclick="prosesPembayaranHutang()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Bayar</button>
            </div>
        </div>
    </div>
    
    <div id="tempStruk" class="off-screen-struk"></div>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    
        let db;
        let dataTransaksi = {};
        let idHutangAktif = null;

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = window.indexedDB.open("MyChickenDB", 3);
    
                request.onerror = event => {
                    reject('Database error: ' + event.target.errorCode);
                };
    
                request.onsuccess = event => {
                    db = event.target.result;
                    console.log("Database opened successfully");
                    resolve();
                };
    
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('riwayat')) {
                        const riwayatStore = db.createObjectStore('riwayat', { keyPath: 'id', autoIncrement: true });
                        riwayatStore.createIndex('tanggalIndex', 'tanggal', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('utang')) {
                        const utangStore = db.createObjectStore('utang', { keyPath: 'id', autoIncrement: true });
                        utangStore.createIndex('riwayatId', 'riwayatId', { unique: true });
                    }
                };
            });
        }
    
        async function initApp() {
            try {
                await openDatabase();
                hitungTotal();
            } catch (error) {
                console.error("Failed to initialize app:", error);
                alert("Gagal memuat database. Aplikasi mungkin tidak berfungsi dengan baik.");
            }
        }
    
        initApp();
    
        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(angka);
        }
    
        function hitungTotal() {
            const hargaPerKg = parseFloat(document.getElementById('hargaPerKg').value) || 0;
            const beratTotal = parseFloat(document.getElementById('beratTotal').value) || 0;
            const jumlahEkor = parseInt(document.getElementById('jumlahEkor').value) || 0;
            
            const total = hargaPerKg * beratTotal;
            
            document.getElementById('totalHarga').textContent = formatRupiah(total);
            document.getElementById('detailHarga').textContent = 
                `${beratTotal} kg √ó ${formatRupiah(hargaPerKg)} = ${formatRupiah(total)}`;
            
            const btnLanjut = document.getElementById('btnLanjut');
            if (beratTotal > 0 && jumlahEkor > 0) {
                btnLanjut.disabled = false;
            } else {
                btnLanjut.disabled = true;
            }
        }
    
        document.getElementById('hargaPerKg').addEventListener('input', hitungTotal);
        document.getElementById('beratTotal').addEventListener('input', hitungTotal);
        document.getElementById('jumlahEkor').addEventListener('input', hitungTotal);
    
        function lanjutKeHalaman2() {
            dataTransaksi.hargaPerKg = parseFloat(document.getElementById('hargaPerKg').value);
            dataTransaksi.beratTotal = parseFloat(document.getElementById('beratTotal').value);
            dataTransaksi.jumlahEkor = parseInt(document.getElementById('jumlahEkor').value);
            dataTransaksi.totalAyam = dataTransaksi.hargaPerKg * dataTransaksi.beratTotal;
            
            document.getElementById('ringkasanBerat').textContent = `${dataTransaksi.beratTotal} kg`;
            document.getElementById('ringkasanEkor').textContent = `${dataTransaksi.jumlahEkor} ekor`;
            document.getElementById('ringkasanTotal').textContent = formatRupiah(dataTransaksi.totalAyam);
            document.getElementById('hargaAyamFinal').textContent = formatRupiah(dataTransaksi.totalAyam);
            
            hitungTotalAkhir();
            
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page2').classList.remove('hidden');
        }
    
        document.querySelectorAll('input[name="bubut"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const hargaBubutContainer = document.getElementById('hargaBubutContainer');
                if (this.value === 'ya') {
                    hargaBubutContainer.classList.remove('hidden');
                } else {
                    hargaBubutContainer.classList.add('hidden');
                }
                hitungTotalAkhir();
            });
        });
    
        function hitungTotalAkhir() {
            const perluBubut = document.querySelector('input[name="bubut"]:checked').value === 'ya';
            const hargaBubut = parseFloat(document.getElementById('hargaBubut').value) || 0;
            
            let biayaBubut = 0;
            if (perluBubut) {
                biayaBubut = hargaBubut * dataTransaksi.jumlahEkor;
                document.getElementById('hargaBubutRow').style.display = 'flex';
                document.getElementById('biayaBubut').textContent = formatRupiah(biayaBubut);
            } else {
                document.getElementById('hargaBubutRow').style.display = 'none';
            }
            
            const totalBayar = dataTransaksi.totalAyam + biayaBubut;
            document.getElementById('totalBayar').textContent = formatRupiah(totalBayar);
            
            dataTransaksi.biayaBubut = biayaBubut;
            dataTransaksi.totalBayar = totalBayar;
            dataTransaksi.perluBubut = perluBubut;
            
            hitungKembalian();
        }
    
        document.getElementById('hargaBubut').addEventListener('input', hitungTotalAkhir);
        document.getElementById('uangDibayar').addEventListener('input', hitungKembalian);
    
        function hitungKembalian() {
            const uangDibayar = parseFloat(document.getElementById('uangDibayar').value) || 0;
            const kembalian = uangDibayar - dataTransaksi.totalBayar;
            
            if (uangDibayar > 0) {
                document.getElementById('kembalianContainer').style.display = 'block';
                if (kembalian >= 0) {
                    document.getElementById('kembalian').textContent = formatRupiah(kembalian);
                    document.getElementById('kembalian').className = 'text-xl font-bold text-green-600';
                } else {
                    document.getElementById('kembalian').textContent = formatRupiah(Math.abs(kembalian)) + ' (kurang)';
                    document.getElementById('kembalian').className = 'text-xl font-bold text-red-600';
                }
            } else {
                document.getElementById('kembalianContainer').style.display = 'none';
            }
            
            dataTransaksi.uangDibayar = uangDibayar;
            dataTransaksi.kembalian = kembalian;
        }
    
        function kembaliKeHalaman1() {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page1').classList.remove('hidden');
        }
    
        async function selesaikanTransaksi() {
            const namaPembeli = document.getElementById('namaPembeli').value.trim();
            const uangDibayar = parseFloat(document.getElementById('uangDibayar').value) || 0;
            const totalBayar = dataTransaksi.totalBayar;
            
            if (!namaPembeli) {
                alert('Mohon isi nama pembeli!');
                return;
            }
            
            dataTransaksi.namaPembeli = namaPembeli;
            dataTransaksi.uangDibayar = uangDibayar;
            
            if (uangDibayar < totalBayar) {
                 const sisaHutang = totalBayar - uangDibayar;
                 dataTransaksi.sisaHutang = sisaHutang;
                 dataTransaksi.status = 'Hutang';
                 
                 const riwayatId = await simpanKeRiwayat();
                 simpanKeUtang(riwayatId);
                 updateStruk();

            } else {
                dataTransaksi.kembalian = uangDibayar - totalBayar;
                dataTransaksi.status = 'Lunas';
                dataTransaksi.sisaHutang = 0;

                await simpanKeRiwayat();
                updateStruk();
            }
        }
    
        async function simpanKeRiwayat() {
            return new Promise((resolve, reject) => {
                const data = {
                    nama: dataTransaksi.namaPembeli,
                    berat: dataTransaksi.beratTotal,
                    ekor: dataTransaksi.jumlahEkor,
                    total: dataTransaksi.totalBayar,
                    perluBubut: dataTransaksi.perluBubut,
                    biayaBubut: dataTransaksi.biayaBubut,
                    uangDibayar: dataTransaksi.uangDibayar,
                    kembalian: dataTransaksi.kembalian,
                    sisaHutang: dataTransaksi.sisaHutang,
                    status: dataTransaksi.status,
                    tanggal: new Date().toISOString()
                };
                const transaction = db.transaction(['riwayat'], 'readwrite');
                const store = transaction.objectStore('riwayat');
                const request = store.add(data);
                
                request.onsuccess = event => {
                    resolve(event.target.result);
                };

                request.onerror = event => {
                    reject(event.target.errorCode);
                };
            });
        }

        async function simpanKeUtang(riwayatId) {
             const data = {
                riwayatId: riwayatId,
                nama: dataTransaksi.namaPembeli,
                berat: dataTransaksi.beratTotal,
                ekor: dataTransaksi.jumlahEkor,
                total: dataTransaksi.sisaHutang,
                tanggal: new Date().toISOString()
            };
            const transaction = db.transaction(['utang'], 'readwrite');
            const store = transaction.objectStore('utang');
            store.add(data);
            alert('Transaksi berhasil disimpan sebagai hutang!');
        }

        async function simpanHutang() {
            const namaPembeli = document.getElementById('namaPembeli').value.trim();
            const totalBayar = dataTransaksi.totalBayar;
            
            if (!namaPembeli) {
                alert('Mohon isi nama pembeli untuk menyimpan hutang!');
                return;
            }

            dataTransaksi.namaPembeli = namaPembeli;
            dataTransaksi.uangDibayar = 0;
            dataTransaksi.kembalian = 0;
            dataTransaksi.sisaHutang = totalBayar;
            dataTransaksi.status = 'Hutang';

            const riwayatId = await simpanKeRiwayat();
            simpanKeUtang(riwayatId);
            transaksiBaru();
        }
    
        function updateStruk() {
            document.getElementById('tanggalTransaksi').textContent = 
                new Date().toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            
            document.getElementById('strukNama').textContent = dataTransaksi.namaPembeli;
            document.getElementById('strukBerat').textContent = `${dataTransaksi.beratTotal} kg`;
            document.getElementById('strukEkor').textContent = `${dataTransaksi.jumlahEkor}`;
            document.getElementById('strukHargaKg').textContent = formatRupiah(dataTransaksi.hargaPerKg);
            document.getElementById('strukSubtotal').textContent = formatRupiah(dataTransaksi.totalAyam);
            document.getElementById('strukTotal').textContent = formatRupiah(dataTransaksi.totalBayar);
            
            document.getElementById('strukBubutRow').style.display = dataTransaksi.perluBubut ? 'flex' : 'none';
            document.getElementById('strukBiayaBubut').textContent = dataTransaksi.perluBubut ? formatRupiah(dataTransaksi.biayaBubut) : 'Rp 0';
            
            document.getElementById('strukDibayarRow').style.display = 'flex';
            document.getElementById('strukDibayar').textContent = formatRupiah(dataTransaksi.uangDibayar);
    
            document.getElementById('strukSisaHutangRow').style.display = dataTransaksi.status === 'Hutang' ? 'flex' : 'none';
            document.getElementById('strukKembalianRow').style.display = dataTransaksi.status !== 'Hutang' ? 'flex' : 'none';
            
            document.getElementById('strukSisaHutang').textContent = dataTransaksi.status === 'Hutang' ? formatRupiah(dataTransaksi.sisaHutang) : 'Rp 0';
            document.getElementById('strukKembalian').textContent = dataTransaksi.status !== 'Hutang' ? formatRupiah(dataTransaksi.kembalian) : 'Rp 0';
            
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page3').classList.remove('hidden');
        }
    
        function transaksiBaru() {
            document.getElementById('beratTotal').value = '';
            document.getElementById('jumlahEkor').value = '';
            document.getElementById('namaPembeli').value = '';
            document.getElementById('uangDibayar').value = '';
            document.querySelector('input[name="bubut"][value="tidak"]').checked = true;
            document.getElementById('hargaBubutContainer').classList.add('hidden');
            
            dataTransaksi = {};
            
            hitungTotal();
            
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page1').classList.remove('hidden');
        }
    
        async function lanjutKeHutang() {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page4').classList.remove('hidden');
            await tampilHutang();
        }
    
        async function tampilHutang() {
            const daftarHutang = document.getElementById('daftarHutang');
            daftarHutang.innerHTML = ''; 
            
            let totalHutangKeseluruhan = 0;
    
            const transaction = db.transaction(['utang'], 'readonly');
            const store = transaction.objectStore('utang');
            const request = store.getAll();
    
            request.onsuccess = event => {
                const utang = event.target.result;
                if (utang.length > 0) {
                    utang.forEach(row => {
                        totalHutangKeseluruhan += row.total;
                        const tanggalFormatted = new Date(row.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
    
                        const hutangCard = document.createElement('div');
                        hutangCard.className = "bg-gray-50 rounded-xl p-4 shadow-sm border-l-4 border-red-400";
                        hutangCard.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-gray-800">${row.nama}</span>
                                <span class="text-sm text-gray-500">${tanggalFormatted}</span>
                            </div>
                            <div class="text-sm space-y-1">
                                <div class="flex justify-between">
                                    <span>Berat:</span>
                                    <span>${row.berat} kg</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Jumlah Ekor:</span>
                                    <span>${row.ekor} ekor</span>
                                </div>
                            </div>
                            <div class="flex justify-between font-bold text-red-600 mt-2">
                                <span>Total Hutang:</span>
                                <span>${formatRupiah(row.total)}</span>
                            </div>
                            <div class="flex space-x-2 mt-4">
                                <button onclick="bukaModalBayar(${row.id}, '${row.nama}', ${row.total})"
                                    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors">
                                    Bayar
                                </button>
                                <button onclick="hapusHutang(${row.id})"
                                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm transition-colors">
                                    Hapus
                                </button>
                            </div>
                        `;
                        daftarHutang.appendChild(hutangCard);
                    });
                } else {
                    daftarHutang.innerHTML = '<p class="text-center text-gray-500">Tidak ada hutang saat ini. üéâ</p>';
                }
                document.getElementById('infoHutang').textContent = `Total hutang saat ini: ${formatRupiah(totalHutangKeseluruhan)}`;
            };
        }
    
        function bukaModalBayar(id, nama, total) {
            idHutangAktif = id;
            document.getElementById('modalNamaHutang').textContent = nama;
            document.getElementById('modalTotalHutang').textContent = formatRupiah(total);
            document.getElementById('inputBayarHutang').value = '';
            document.getElementById('modalBayarHutang').classList.remove('hidden');
        }
    
        function tutupModal() {
            document.getElementById('modalBayarHutang').classList.add('hidden');
        }
    
        async function prosesPembayaranHutang() {
            const jumlahBayar = parseFloat(document.getElementById('inputBayarHutang').value);
            if (isNaN(jumlahBayar) || jumlahBayar <= 0) {
                alert("Jumlah pembayaran tidak valid.");
                return;
            }
    
            const transactionUtang = db.transaction(['utang'], 'readwrite');
            const storeUtang = transactionUtang.objectStore('utang');
            const getRequest = storeUtang.get(idHutangAktif);
    
            getRequest.onsuccess = event => {
                const hutang = event.target.result;
                const totalLama = hutang.total;
                const sisaHutang = totalLama - jumlahBayar;
                
                // Update riwayat
                const transactionRiwayat = db.transaction(['riwayat'], 'readwrite');
                const storeRiwayat = transactionRiwayat.objectStore('riwayat');
                const getRiwayatRequest = storeRiwayat.get(hutang.riwayatId);

                getRiwayatRequest.onsuccess = event => {
                    const riwayat = event.target.result;
                    riwayat.sisaHutang = sisaHutang > 0 ? sisaHutang : 0;
                    riwayat.uangDibayar += jumlahBayar;
                    riwayat.status = sisaHutang <= 0 ? 'Lunas' : 'Hutang';
                    storeRiwayat.put(riwayat);
                };

                if (sisaHutang <= 0) {
                    storeUtang.delete(idHutangAktif);
                    alert('Hutang lunas!');
                    if (sisaHutang < 0) {
                        alert(`Ada kembalian sebesar ${formatRupiah(Math.abs(sisaHutang))}`);
                    }
                } else {
                    hutang.total = sisaHutang;
                    storeUtang.put(hutang);
                    alert(`Pembayaran berhasil. Sisa hutang: ${formatRupiah(sisaHutang)}`);
                }
                tutupModal();
                tampilHutang();
            };
        }
    
        async function hapusHutang(id) {
            if (confirm("Apakah Anda yakin ingin menghapus hutang ini? Ini akan mengubah status di riwayat menjadi Lunas.")) {
                const transactionUtang = db.transaction(['utang'], 'readwrite');
                const storeUtang = transactionUtang.objectStore('utang');
                const getRequest = storeUtang.get(id);

                getRequest.onsuccess = event => {
                    const hutang = event.target.result;
                    
                    const transactionRiwayat = db.transaction(['riwayat'], 'readwrite');
                    const storeRiwayat = transactionRiwayat.objectStore('riwayat');
                    const getRiwayatRequest = storeRiwayat.get(hutang.riwayatId);
                    
                    getRiwayatRequest.onsuccess = event => {
                        const riwayat = event.target.result;
                        riwayat.sisaHutang = 0;
                        riwayat.status = 'Lunas';
                        storeRiwayat.put(riwayat);
                    };

                    storeUtang.delete(id);
                    alert('Hutang berhasil dihapus dan status riwayat diubah menjadi Lunas.');
                    tampilHutang();
                };
            }
        }
    
        async function lanjutKeRiwayat() {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page5').classList.remove('hidden');
            await tampilRiwayat();
        }
        
        async function tampilRiwayat() {
            const daftarRiwayat = document.getElementById('daftarRiwayat');
            daftarRiwayat.innerHTML = '';
            
            const transaction = db.transaction(['riwayat'], 'readonly');
            const store = transaction.objectStore('riwayat');
            const request = store.getAll();
    
            request.onsuccess = event => {
                const riwayat = event.target.result.reverse();
                if (riwayat.length > 0) {
                    riwayat.forEach(row => {
                        const tanggalFormatted = new Date(row.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        
                        const statusBadge = row.status === 'Hutang' ?
                            `<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-semibold">Hutang</span>` :
                            `<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-semibold">Lunas</span>`;
                            
                        const totalBayarDisplay = row.status === 'Hutang' ? `Total Transaksi: ${formatRupiah(row.total)}` : `Total Bayar: ${formatRupiah(row.total)}`;
                            
                        const riwayatCard = document.createElement('div');
                        riwayatCard.className = "bg-gray-50 rounded-xl p-4 shadow-sm border-l-4 border-blue-400";
                        riwayatCard.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center space-x-2">
                                    <span class="font-bold text-gray-800">${row.nama}</span>
                                    ${statusBadge}
                                </div>
                                <span class="text-sm text-gray-500">${tanggalFormatted}</span>
                            </div>
                            <div class="text-sm space-y-1">
                                <div class="flex justify-between">
                                    <span>Berat:</span>
                                    <span>${row.berat} kg</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Jumlah Ekor:</span>
                                    <span>${row.ekor} ekor</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Biaya Bubut:</span>
                                    <span>${row.perluBubut ? formatRupiah(row.biayaBubut) : 'Tidak Ada'}</span>
                                </div>
                            </div>
                            <div class="flex justify-between font-bold text-blue-600 mt-2">
                                <span>${totalBayarDisplay}</span>
                            </div>
                            <div class="flex space-x-2 mt-4">
                                <button onclick="hapusRiwayat(${row.id})"
                                    class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm transition-colors">
                                    Hapus
                                </button>
                            </div>
                        `;
                        daftarRiwayat.appendChild(riwayatCard);
                    });
                } else {
                    daftarRiwayat.innerHTML = '<p class="text-center text-gray-500">Tidak ada riwayat transaksi saat ini. üéâ</p>';
                }
                document.getElementById('infoRiwayat').textContent = `Total riwayat transaksi: ${riwayat.length} transaksi`;
            };
        }
        
        async function hapusRiwayat(id) {
            if (confirm("Apakah Anda yakin ingin menghapus riwayat ini?")) {
                const transaction = db.transaction(['riwayat'], 'readwrite');
                const store = transaction.objectStore('riwayat');
                store.delete(id);
                alert('Riwayat berhasil dihapus.');
                tampilRiwayat();
            }
        }
    
        function downloadStruk() {
            const strukElement = document.getElementById('struk');
            html2canvas(strukElement, { scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `struk-${dataTransaksi.namaPembeli.replace(/\s/g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        function lanjutKeLaporan() {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page6').classList.remove('hidden');
            tampilLaporan();
        }

        let myChart;
        function tampilLaporan() {
            if (!db) return;
            const transaction = db.transaction(['riwayat'], 'readonly');
            const store = transaction.objectStore('riwayat');
            const request = store.getAll();

            request.onsuccess = event => {
                const riwayat = event.target.result;
                let totalHarian = 0;
                let totalBulanan = 0;
                let totalKeseluruhan = 0;
                const now = new Date();
                const hariIni = now.getDate();
                const bulanIni = now.getMonth();
                const tahunIni = now.getFullYear();

                const dataBulanan = {};

                riwayat.forEach(item => {
                    totalKeseluruhan += item.total;
                    const tanggal = new Date(item.tanggal);
                    const bulanTahun = `${tanggal.getFullYear()}-${tanggal.getMonth()}`;

                    if (tanggal.getDate() === hariIni && tanggal.getMonth() === bulanIni && tanggal.getFullYear() === tahunIni) {
                        totalHarian += item.total;
                    }
                    if (tanggal.getMonth() === bulanIni && tanggal.getFullYear() === tahunIni) {
                        totalBulanan += item.total;
                    }

                    if (!dataBulanan[bulanTahun]) {
                        dataBulanan[bulanTahun] = 0;
                    }
                    dataBulanan[bulanTahun] += item.total;
                });

                document.getElementById('totalHarian').textContent = formatRupiah(totalHarian);
                document.getElementById('totalBulanan').textContent = formatRupiah(totalBulanan);
                document.getElementById('totalKeseluruhan').textContent = formatRupiah(totalKeseluruhan);

                const labels = Object.keys(dataBulanan).sort().map(key => {
                    const [tahun, bulan] = key.split('-');
                    const namaBulan = new Date(tahun, bulan).toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                    return namaBulan;
                });
                const data = Object.keys(dataBulanan).sort().map(key => dataBulanan[key]);

                if (myChart) {
                    myChart.destroy();
                }

                const ctx = document.getElementById('grafikPenjualan').getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Pendapatan Bulanan',
                            data: data,
                            backgroundColor: 'rgba(249, 115, 22, 0.6)',
                            borderColor: '#F97316',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'Rp ' + value.toLocaleString('id-ID');
                                    }
                                }
                            }
                        }
                    }
                });
            };
        }
    </script>
</body>
</html>